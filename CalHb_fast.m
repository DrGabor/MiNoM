function [H, b] = CalHb_fast(params, bFast)
Aft = params.Aft;
Ref = params.Ref;
Mov = params.Mov;
w   = params.W;
w = w / sum(w);
MArray = params.MArray;
Tf = params.Tf;
R = Tf(1:3, 1:3);
PtsDiff = Aft - Ref;
if bFast
    %%%%%% assign to variables.
    m1 = MArray(1,:);
    m2 = MArray(2,:);
    m3 = MArray(3,:);
    m4 = MArray(4,:);
    m5 = MArray(5,:);
    m6 = MArray(6,:);
    R1_1 = R(1);
    R1_2 = R(4);
    R1_3 = R(7);
    R2_1 = R(2);
    R2_2 = R(5);
    R2_3 = R(8);
    R3_1 = R(3);
    R3_2 = R(6);
    R3_3 = R(9);
    v1 = PtsDiff(1,:);
    v2 = PtsDiff(2,:);
    v3 = PtsDiff(3,:);
    p1 = Mov(1,:);
    p2 = Mov(2,:);
    p3 = Mov(3,:);
    t2 = R1_2.*p3;
    t6 = R1_3.*p2;
    t3 = t2-t6;
    t4 = R2_2.*p3;
    t7 = R2_3.*p2;
    t5 = t4-t7;
    t8 = R3_2.*p3;
    t10 = R3_3.*p2;
    t9 = t8-t10;
    t11 = m1.*t3.*w;
    t12 = m2.*t5.*w;
    t13 = m3.*t9.*w;
    t14 = t11+t12+t13;
    t15 = m2.*t3.*w;
    t16 = m4.*t5.*w;
    t17 = m5.*t9.*w;
    t18 = t15+t16+t17;
    t19 = m3.*t3.*w;
    t20 = m5.*t5.*w;
    t21 = m6.*t9.*w;
    t22 = t19+t20+t21;
    t23 = R1_1.*p3;
    t29 = R1_3.*p1;
    t24 = t23-t29;
    t25 = R2_1.*p3;
    t30 = R2_3.*p1;
    t26 = t25-t30;
    t27 = R3_1.*p3;
    t31 = R3_3.*p1;
    t28 = t27-t31;
    t32 = m1.*t24.*w;
    t33 = m2.*t26.*w;
    t34 = m3.*t28.*w;
    t35 = t32+t33+t34;
    t36 = m2.*t24.*w;
    t37 = m4.*t26.*w;
    t38 = m5.*t28.*w;
    t39 = t36+t37+t38;
    t40 = m3.*t24.*w;
    t41 = m5.*t26.*w;
    t42 = m6.*t28.*w;
    t43 = t40+t41+t42;
    t44 = R1_1.*p2;
    t50 = R1_2.*p1;
    t45 = t44-t50;
    t46 = R2_1.*p2;
    t51 = R2_2.*p1;
    t47 = t46-t51;
    t48 = R3_1.*p2;
    t52 = R3_2.*p1;
    t49 = t48-t52;
    t53 = m1.*t45.*w;
    t54 = m2.*t47.*w;
    t55 = m3.*t49.*w;
    t56 = t53+t54+t55;
    t57 = m2.*t45.*w;
    t58 = m4.*t47.*w;
    t59 = m5.*t49.*w;
    t60 = t57+t58+t59;
    t61 = m3.*t45.*w;
    t62 = m5.*t47.*w;
    t63 = m6.*t49.*w;
    t64 = t61+t62+t63;
    t65 = -t11-t12-t13;
    t66 = -t53-t54-t55;
    t67 = -t15-t16-t17;
    t68 = -t57-t58-t59;
    t69 = m2.*w;
    t70 = -t19-t20-t21;
    t71 = -t61-t62-t63;
    t72 = m3.*w;
    t73 = m5.*w;
    
    A0(0+1,0+1) = sum(t3.*t14+t5.*t18+t9.*t22);
    A0(0+1,1+1) = sum(-t14.*t24-t18.*t26-t22.*t28);
    A0(0+1,2+1) =  sum(t14.*t45+t18.*t47+t22.*t49);
    A0(0+1,3+1) =  sum(t65);
    A0(0+1,4+1) =  sum(t67);
    A0(0+1,5+1) =  sum(t70);
    A0(0+1,6+1) =  sum(-t14.*v1-t18.*v2-t22.*v3);
    A0(1+1,0+1) =  sum(-t3.*t35-t5.*t39-t9.*t43);
    A0(1+1,1+1) =  sum(t24.*t35+t26.*t39+t28.*t43);
    A0(1+1,2+1) =  sum(-t35.*t45-t39.*t47-t43.*t49);
    A0(1+1,3+1) =  sum(t35);
    A0(1+1,4+1) =  sum(t39);
    A0(1+1,5+1) =  sum(t43);
    A0(1+1,6+1) =  sum(t35.*v1+t39.*v2+t43.*v3);
    A0(2+1,0+1) =  sum(t3.*t56+t5.*t60+t9.*t64);
    A0(2+1,1+1) =  sum(-t24.*t56-t26.*t60-t28.*t64);
    A0(2+1,2+1) =  sum(t45.*t56+t47.*t60+t49.*t64);
    A0(2+1,3+1) =  sum(t66);
    A0(2+1,4+1) =  sum(t68);
    A0(2+1,5+1) =  sum(t71);
    A0(2+1,6+1) =  sum(-t56.*v1-t60.*v2-t64.*v3);
    A0(3+1,0+1) =  sum(t65);
    A0(3+1,1+1) =  sum(t35);
    A0(3+1,2+1) =  sum(t66);
    A0(3+1,3+1) =  sum(m1.*w);
    A0(3+1,4+1) =  sum(t69);
    A0(3+1,5+1) =  sum(t72);
    A0(3+1,6+1) =  sum(w.*(m1.*v1+m2.*v2+m3.*v3));
    A0(4+1,0+1) =  sum(t67);
    A0(4+1,1+1) =  sum(t39);
    A0(4+1,2+1) =  sum(t68);
    A0(4+1,3+1) =  sum(t69);
    A0(4+1,4+1) =  sum(m4.*w);
    A0(4+1,5+1) =  sum(t73);
    A0(4+1,6+1) =  sum(w.*(m2.*v1+m4.*v2+m5.*v3));
    A0(5+1,0+1) =  sum(t70);
    A0(5+1,1+1) =  sum(t43);
    A0(5+1,2+1) =  sum(t71);
    A0(5+1,3+1) =  sum(t72);
    A0(5+1,4+1) =  sum(t73);
    A0(5+1,5+1) =  sum(m6.*w);
    A0(5+1,6+1) =  sum(w.*(m3.*v1+m5.*v2+m6.*v3));
    H = A0(:, 1:6);
    b = A0(:, end);
else
    H = zeros(6, 6);
    b = zeros(6, 1);
    parfor id = 1 : 1 : size(PtsDiff, 2)
        v = PtsDiff(:, id);
        pt_mov = Mov(:, id);
        A = [-R*SkewFun(pt_mov) eye(3)];
        w = W(id);
        m = MArray(:, id);
        M = [m(1) m(2) m(3)
            m(2) m(4) m(5)
            m(3) m(5) m(6)];
        H = H + w * A'*M*A;
        b = b + w * A'*M*v;
    end
end
end

